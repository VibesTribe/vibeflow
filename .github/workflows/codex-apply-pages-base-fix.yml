name: Codex - Apply Pages base fix
on:
  workflow_dispatch: {}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1) Core Pages fix: relative base in production
      - name: Write vite.config.ts
        run: |
          cat > vite.config.ts <<'EOF'
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';

          const base = process.env.NODE_ENV === 'production' ? './' : '/';

          export default defineConfig({
            base,
            plugins: [react()],
            server: {
              port: 5173,
              host: true
            }
          });
          EOF

      # 2) Optional: add canvas route normalization if src/main.tsx exists
      - name: Patch src/main.tsx (optional)
        shell: bash
        run: |
          if [ -f src/main.tsx ]; then
            node - <<'NODE'
            const fs = require('fs');
            const p = 'src/main.tsx';
            let s = fs.readFileSync(p, 'utf8');

            // Insert normalization block after the "param" line if not present already
            if (!/normalizedPath\\.endsWith\\('\\/visual-canvas'\\)/.test(s)) {
              s = s.replace(
                /(const param = [^\\n]*\\n)/,
                `$1
  const normalizedPath = url.pathname.replace(/\\/+$/, '');
  if (normalizedPath.endsWith('/visual-canvas')) {
    return 'canvas';
  }
`
              );
              fs.writeFileSync(p, s);
              console.log('Inserted route normalization in src/main.tsx');
            } else {
              console.log('Route normalization already present; skipping.');
            }
            NODE
          else
            echo "src/main.tsx not found; skipping."
          fi

      # 3) Optional: rewrite config URL to use BASE_URL across src/**
      - name: Rewrite visual-canvas config URL (optional)
        shell: bash
        run: |
          if [ -d src ]; then
            node - <<'NODE'
            const fs = require('fs');
            const path = require('path');
            const root = 'src';
            let changed = 0;
            function walk(dir) {
              for (const name of fs.readdirSync(dir)) {
                const full = path.join(dir, name);
                const st = fs.statSync(full);
                if (st.isDirectory()) walk(full);
                else if (/\.(t|j)sx?$/.test(name)) {
                  let s = fs.readFileSync(full, 'utf8');
                  const next = s.replace(
                    /(['"`])\/visual-canvas\/config\.json\1/g,
                    '`${import.meta.env.BASE_URL}visual-canvas/config.json`'
                  );
                  if (next !== s) {
                    fs.writeFileSync(full, next);
                    changed++;
                    console.log('Patched:', full);
                  }
                }
              }
            }
            walk(root);
            console.log(`Patched files: ${changed}`);
            NODE
          else
            echo "src/ not present; skipping."
          fi

      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix(pages): relative Vite base; optional canvas route + config URL updates"
          git push
